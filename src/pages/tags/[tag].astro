---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostCard from "../../components/PostCard.astro";
import { getAllTags } from "../../lib/utils/posts";

export async function getStaticPaths() {
  const tags = await getAllTags();
  
  return tags.map((tag) => ({
    params: { tag },
    props: { tag }
  }));
}

const { tag } = Astro.props;
const posts = await getCollection("posts", ({ data }) => {
  return (import.meta.env.DEV || !data.draft) && data.tags.includes(tag);
});

const sortedPosts = posts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const title = `Posts com a tag "${tag}"`;
const description = `Todos os posts do blog sobrecoisas com a tag "${tag}"`;
---

<BaseLayout title={title} description={description}>
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-center">
      Posts com a tag <span class="text-gray-600">"{tag}"</span>
    </h1>
    <p class="mt-2 text-center text-gray-500">
      {posts.length} {posts.length === 1 ? "post encontrado" : "posts encontrados"}
    </p>
  </header>

  {posts.length > 0 ? (
    <section class="space-y-8">
      {sortedPosts.map((post) => <PostCard post={post} />)}
    </section>
  ) : (
    <p class="text-center text-gray-500">
      Nenhum post encontrado com esta tag.
    </p>
  )}
</BaseLayout>
